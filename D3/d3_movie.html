<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 13px;
      }
      .top-label {
        font-size: 13px;
        font-style: italic;
        text-transform: uppercase;
        float: left;
      }
      .movie-label {
        text-align: right;
        font-weight: bold;
        width: 145px;
        padding-right: 10px;
      }
      .clearfix {
        clear: both;
      }
      .bar {
        fill: darkslateblue;
      }
      .bar-label {
        text-anchor: end;
      }
      .axis-label {
        text-anchor: middle;
      }
      .button{
        float:left;
        margin-left:10px;
        cursor:pointer
      }
      .selected{
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      async function makeChart() {
        // const data = [
        //   {
        //     name: "극한직업",
        //     value: 16264984,
        //   },
        //   {
        //     name: "어벤져스:엔드게임",
        //     value: 13977602,
        //   },
        //   {
        //     name: "겨울왕국2",
        //     value: 13747792,
        //   },
        //   {
        //     name: "알라딘",
        //     value: 12551371,
        //   },
        //   {
        //     name: "기생충",
        //     value: 10083172,
        //   },
        //   {
        //     name: "엑시트",
        //     value: 9414388,
        //   },
        //   {
        //     name: "스파이더맨:파 프롬 홈",
        //     value: 8021290,
        //   },
        // ];
        const data = await d3.json("./data_74/movie2.json");
        let year = '2019'
        let selectedDate = data.filter(el=>el.year === year)

        const nameList = selectedDate.map((d) => d.name);
        const valueList = selectedDate.map((d) => d.value);
        const years = ['2020','2019','2018','2017','2016','2015']
        const title = '년 1000만 관객 기록한 영화 관객수 TOP7';

        const margin = { top: 30, right: 50, bottom: 0, left: 150 };
        const width = 400;
        const height = 170;

        const x = d3
          .scaleLinear()
          .domain([0, d3.max(selectedDate, (d) => d.value)])
          .range([0, width]);

        const xAxis = d3
          .axisTop(x)
          .ticks(4)
          .tickFormat((d, i) => `${!!d ? Math.floor(d / 10000) : d}만명`);

        const y = d3.scaleBand().domain(nameList).range([0, height]).paddingInner(0.2);

        const yAxis = d3.axisLeft(y);

        const body = d3.select("body");

        body.append("h2").text(year+title);

        
        const button = body.append('div').attr('class','buttons-container').selectAll('div').data(years).join('div').text(d=>d)
          .attr('class', d=>{
            if(d===year){
              return 'button selected'
            }
            else {
              return 'button'
            }
          })

        body.append("div").attr("class", "top-label movie-label").append("p").text("영화");
        body.append("div").attr("class", "top-label").append("p").text("관객수");
        body.append("div").attr("class", "clearfix");

        //const svg = body.append("svg");
        const svgGroup = body
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", width + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const barGroup = svgGroup.append("g").attr("class", "bar");

        const barHeight = 20;
        const barGap = 5;
        const barSpacing = barHeight + barGap;

        // valueList.forEach((value, idx) => {
        //   barGroup
        //     .append("rect")
        //     .attr("x", "0")
        //     .attr("y", barSpacing * idx)
        //     .attr("height", barHeight)
        //     .attr("width", value);
        // });

        const bars = barGroup
          .selectAll("rect")
          .data(selectedDate)
          .join("rect")
          .attr("x", 0)
          .attr("y", (d, i) => y(d.name))
          .attr("height", barHeight)
          .attr("width", (d) => x(d.value));

        // const barLabel = svgGroup.append("g").attr("class", "bar-label");

        // nameList.forEach((name, idx) => {
        //   barLabel
        //     .append("text")
        //     .attr("x", 140)
        //     .attr("y", barHeight * (idx + 2) + barGap * (idx + 1))
        //     .text(name);
        // });

        // barLabel
        //   .selectAll("rect")
        //   .data(data)
        //   .join("text")
        //   .attr("x", 140)
        //   .attr("y", (d, i) => barHeight * (i + 2) + barGap * (i + 1))
        //   .text((d) => d.name);

        const tickHeight = -10;
        const tickGap = -5;
        const axisData = [0, 5601253, 11202506, 16803759];

        svgGroup.append("g").call(xAxis).attr("class", "x-axis");
        svgGroup.append("g").call(yAxis).attr("class", "y-axis");

        // const xAxis = svgGroup.append("g").attr("stroke", "black");
        // const xScale = svgGroup.append("g").attr("class", "axis-label");

        // for (let i = 0; i < 4; i++) {
        //   xAxis
        //     .append("line")
        //     .attr("x1", axisData[i] * scaleFactor)
        //     .attr("y1", "0")
        //     .attr("x2", axisData[i] * scaleFactor)
        //     .attr("y2", tickHeight);

        //   xScale
        //     .append("text")
        //     .attr("x", axisData[i] * scaleFactor)
        //     .attr("y", tickGap + tickHeight)
        //     .text(`${!!axisData[i] ? Math.floor(axisData[i] / 100000) : axisData[i]}만명`);
        // }

        // xAxis
        //   .selectAll("line")
        //   .data(axisData)
        //   .join("line")
        //   .attr("x1", (d, i) => {
        //     return x(d);
        //   })
        //   .attr("y1", "0")
        //   .attr("x2", (d, i) => {
        //     return x(d);
        //   })
        //   .attr("y2", tickHeight);

        // xScale
        //   .selectAll("text")
        //   .data(axisData)
        //   .join("text")
        //   .attr("x", (d, i) => {
        //     return x(d);
        //   })
        //   .attr("y", tickGap + tickHeight)
        //   .text((d, i) => `${!!d ? Math.floor(d / 10000) : d}만명`);

        button.on('click',function(el,d){
          d3.select('.selected').classed('selected',false);
          d3.select(this).classed('selected',true);

          year = d
          selectedDate = data.filter(el=>el.year === year)

          y.domain(selectedDate.map(d=>d.name));
          const yAxis = d3.axisLeft(y);
          svgGroup.selectAll('g.y-axis').call(yAxis);
          bars.data(selectedDate)
            .transition()
            //.duration(500)
            //.delay(500)
            .ease(d3.easeBounce) //easeBack,easeLinear도 있음
            .attr('y',d=>y(d.name))
            .attr('width',d=>x(d.value))

          body.selectAll('h2').text(year+title)
        })
      }

      makeChart();
    </script>
  </body>
</html>
